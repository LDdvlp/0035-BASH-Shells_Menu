name: CD

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  cd-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # important pour voir tous les tags et l'historique

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run lint
        run: make lint

      - name: Set version and default branch
        id: vars
        run: |
          echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          echo "DEFAULT_BRANCH=${GITHUB_REF_NAME%%/*}" >> $GITHUB_ENV || true
          echo "VERSION=${GITHUB_REF_NAME}"
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Detect previous tag
        id: prev_tag
        run: |
          VERSION="${VERSION}"
          # On essaie de trouver le tag précédent (celui juste avant VERSION)
          if git describe --tags --abbrev=0 "${VERSION}^" >/dev/null 2>&1; then
            PREV_TAG=$(git describe --tags --abbrev=0 "${VERSION}^")
            echo "PREV_TAG=${PREV_TAG}" >> $GITHUB_ENV
            echo "Previous tag: ${PREV_TAG}"
          else
            echo "PREV_TAG=" >> $GITHUB_ENV
            echo "No previous tag found (first release or non-linear history)."
          fi

      - name: Update CHANGELOG on default branch
        run: |
          # On se place sur la branche par défaut du dépôt
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          VERSION="${VERSION}"
          PREV_TAG="${PREV_TAG}"

          echo "Default branch: ${DEFAULT_BRANCH}"
          git checkout "$DEFAULT_BRANCH"

          # S'assurer que le script est exécutable
          chmod +x tools/generate_changelog.sh

          # Générer/mettre à jour le CHANGELOG
          ./tools/generate_changelog.sh "${VERSION}" "${PREV_TAG}"

      - name: Build release archives
        run: |
          mkdir -p dist
          git archive --format=tar.gz -o "dist/0035-BASH-Shells_Menu-${VERSION}.tar.gz" "$GITHUB_SHA"
          git archive --format=zip    -o "dist/0035-BASH-Shells_Menu-${VERSION}.zip"    "$GITHUB_SHA"
          ls -lh dist

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          release_name: ${{ env.VERSION }}
          draft: false
          prerelease: false
          body: |
            Release automatique pour la version `${{ env.VERSION }}`.

            Le fichier CHANGELOG.md a été mis à jour automatiquement.
            Voir le dépôt pour le détail des modifications.

      - name: Upload tar.gz asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/0035-BASH-Shells_Menu-${{ env.VERSION }}.tar.gz
          asset_name: 0035-BASH-Shells_Menu-${{ env.VERSION }}.tar.gz
          asset_content_type: application/gzip

      - name: Upload zip asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/0035-BASH-Shells_Menu-${{ env.VERSION }}.zip
          asset_name: 0035-BASH-Shells_Menu-${{ env.VERSION }}.zip
          asset_content_type: application/zip
